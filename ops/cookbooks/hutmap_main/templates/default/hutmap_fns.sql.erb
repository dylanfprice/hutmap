# Generated by Chef for <%= node['hostname'] %>.
# Local modifications will be overwritten.

USE <%= node[:HUTMAP_DB_NAME] %>;

DROP FUNCTION IF EXISTS `distance`;

-- Switch delimiter so the ; will work in the function body
DELIMITER $$

-- Create the function
CREATE FUNCTION `distance`(a POINT, b POINT) RETURNS double 
  DETERMINISTIC 
  COMMENT 'Calculate the distance between two lat/lng points' 
  BEGIN 
    RETURN 6371 * 2 * ASIN(SQRT(POWER(SIN(RADIANS(ABS(X(a)) - ABS(X(b)))), 2) + COS(RADIANS(ABS(X(a)))) * COS(RADIANS(ABS(X(b)))) * POWER(SIN(RADIANS(Y(a) - Y(b))), 2)));
  END$$

-- Switch the delimiter back to ;
DELIMITER ;


CREATE DATABASE IF NOT EXISTS test_<%= node[:HUTMAP_DB_NAME] %>;

USE test_<%= node[:HUTMAP_DB_NAME] %>;

DROP FUNCTION IF EXISTS `distance`;

-- Switch delimiter so the ; will work in the function body
DELIMITER $$

-- Create the function
CREATE FUNCTION `distance`(a POINT, b POINT) RETURNS double 
  DETERMINISTIC 
  COMMENT 'Calculate the distance between two lat/lng points' 
  BEGIN 
    RETURN 6371 * 2 * ASIN(SQRT(POWER(SIN(RADIANS(ABS(X(a)) - ABS(X(b)))), 2) + COS(RADIANS(ABS(X(a)))) * COS(RADIANS(ABS(X(b)))) * POWER(SIN(RADIANS(Y(a) - Y(b))), 2)));
  END$$

-- Switch the delimiter back to ;
DELIMITER ;


